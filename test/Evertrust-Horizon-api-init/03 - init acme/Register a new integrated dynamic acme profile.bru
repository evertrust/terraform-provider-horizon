meta {
  name: Register a new integrated dynamic acme profile
  type: http
  seq: 8
}

post {
  url: {{horizonUrl}}/api/v1/certificate/profiles
  body: json
  auth: none
}

headers {
  X-API-ID: {{X-API-ID}}
  X-API-KEY: {{X-API-KEY}}
}

body:json {
  {
      "module": "acme",
      "enabled": true,
      "name": "evertrust-integrated-dynamic-acme",
      "proxy": null,
      "authorizationMethods": [
          "tls-alpn-01",
          "http-01",
          "dns-01"
      ],
      "verifyRetryCount": 3,
      "verifyRetryDelay": "3 seconds",
      "authorizeShortName": true,
      "authorizeEmptyContact": true,
      "requireTermsOfService": false,
      "cryptoPolicy": {
          "centralized": false,
          "decentralized": true,
          "escrow": false,
          "p12passwordPolicy": null,
          "storeEncryptionType": "DES_AVERAGE",
          "showP12PasswordOnRecover": false,
          "showP12OnRecover": false
      },
      "selfPermissions": {
          "selfRevoke": false,
          "selfRequestRevoke": false,
          "selfUpdate": false,
          "selfRequestUpdate": false,
          "selfRecover": null,
          "selfRequestRecover": null
      },
      "meta": {
          "website": null,
          "termsOfService": null,
          "externalAccountRequired": false,
          "caaIdentities": null
      },
      "pkiConnector": "evertrust-integrated-serverauth",
      "authorizationLevels": {
          "revoke": {
              "accessLevel": "authorized"
          },
          "requestRevoke": {
              "accessLevel": "authorized"
          },
          "approveRevoke": {
              "accessLevel": "authorized"
          },
          "search": {
              "accessLevel": "authorized"
          },
          "migrate": {
              "accessLevel": "authorized"
          },
          "requestMigrate": {
              "accessLevel": "authorized"
          },
          "approveMigrate": {
              "accessLevel": "authorized"
          },
          "update": {
              "accessLevel": "authorized"
          },
          "requestUpdate": {
              "accessLevel": "authorized"
          },
          "approveUpdate": {
              "accessLevel": "authorized"
          }
      },
      "requestsPolicy": {
          "revoke": "30 minutes",
          "update": "1 hour",
          "migrate": "1 hour"
      },
      "displayName": [],
      "description": [],
      "certificateTemplate": {
          "labels": [
              {
                  "label": "{{COMMON_LABEL}}",
                  "mandatory": true,
                  "editableByRequester": true,
                  "editableByApprover": false,
                  "index": 2,
                  "value": "acme-label-dynamic-test",
                  "fieldType": "enum",
                  "computationRule": null
              }
          ],
          "metadataPolicies": [],
          "subject": [
              {
                  "type": "CN",
                  "mandatory": true,
                  "editableByRequester": false,
                  "editableByApprover": false,
                  "index": 2,
                  "value": null,
                  "regex": null,
                  "testing": null,
                  "computationRule": "{{acme.order.label.COMMON_LABEL}}"
              },
              {
                  "type": "SURNAME",
                  "mandatory": true,
                  "editableByRequester": false,
                  "editableByApprover": false,
                  "index": 3,
                  "value": null,
                  "regex": null,
                  "testing": null,
                  "computationRule": "{{csr.san.dnsname.1}}"
              },
              {
                  "type": "E",
                  "mandatory": true,
                  "editableByRequester": false,
                  "editableByApprover": false,
                  "index": 4,
                  "value": null,
                  "regex": null,
                  "testing": null,
                  "computationRule": "{{acme.account.contact.1}}"
              },
              {
                  "type": "OU",
                  "mandatory": true,
                  "editableByRequester": false,
                  "editableByApprover": false,
                  "index": 5,
                  "value": null,
                  "regex": null,
                  "testing": null,
                  "computationRule": "{{acme.account.initialip}}"
              },
              {
                  "type": "DESCRIPTION",
                  "mandatory": true,
                  "editableByRequester": false,
                  "editableByApprover": false,
                  "index": 6,
                  "value": null,
                  "regex": null,
                  "testing": null,
                  "computationRule": "{{acme.order.initialip}}"
              }
          ],
          "sans": [
              {
                  "type": "DNSNAME",
                  "editableByRequester": true
              }
          ],
          "extensions": []
      },
      "constraints": {
          "keyStrictCheck": false,
          "allowedDnsDomains": ".*evertrust\\.fr"
      },
      "csrDataMapping": {},
      "triggers": {
          "onExpire": null,
          "onPendingRevoke": null,
          "onPendingUpdate": null,
          "onPendingMigrate": null
      },
      "timeout": "10 seconds",
      "tlsAlpn01Port": 4443
  }
}

assert {
  res.body: isJson
  res.status: eq 201
  res.body.name: isDefined
  res.body._id: isDefined
}
