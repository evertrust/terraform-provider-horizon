meta {
  name: Register a new ejbca est profile x509 with dn
  type: http
  seq: 10
}

post {
  url: {{horizonUrl}}/api/v1/certificate/profiles
  body: json
  auth: none
}

headers {
  X-API-ID: {{X-API-ID}}
  X-API-KEY: {{X-API-KEY}}
}

body:json {
  {
      "module": "est",
      "enabled": true,
      "name": "evertrust-ejbca-est-x509-with-dn",
      "ca": "v2saca",
      "authorizationMode": "x509",
      "pkiConnector": "evertrust-ejbca-userauth",
      "renewalAuthorizedCas": [
          "v2saca"
      ],
      "requestTtl": "1h",
      "dnWhitelist": true,
      "revokeOnEstRenew": true,
      "revocationReason": "unspecified",
      "authorizationLevels": {
          "requestEnroll": {
              "accessLevel": "authorized"
          },
          "approveEnroll": {
              "accessLevel": "authorized"
          },
          "revoke": {
              "accessLevel": "authorized"
          },
          "requestRevoke": {
              "accessLevel": "authorized"
          },
          "approveRevoke": {
              "accessLevel": "authorized"
          },
          "search": {
              "accessLevel": "authorized"
          },
          "requestUpdate": {
              "accessLevel": "authorized"
          },
          "approveUpdate": {
              "accessLevel": "authorized"
          },
          "update": {
              "accessLevel": "authorized"
          }
      },
      "constraints": {
          "rsaMinimalKeySize": 2048,
          "allowedECurves": "secp256r1,secp384r1,secp521r1",
          "allowedDomains": ".*evertrust\\.fr",
          "allowedDnsDomains": ".*"
      },
      "requestService": {},
      "requestsPolicy": {
          "revoke": "30m"
      },
      "selfPermissions": {},
          "cryptoPolicy": {
          "centralized": false,
          "decentralized": true,
          "escrow": false
      }
  }
}

assert {
  res.body: isJson
  res.status: eq 201
  res.body.name: isDefined
}
